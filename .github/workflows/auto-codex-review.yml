name: Auto Codex Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  request-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Request Codex Review
        uses: actions/github-script@v7
        with:
          script: |
            // Only comment if it's a claude/ branch
            const branch = context.payload.pull_request.head.ref;
            if (!branch.startsWith('claude/')) {
              console.log('Not a claude/ branch, skipping');
              return;
            }

            // Check if we already commented on this commit
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const latestCommit = context.payload.pull_request.head.sha;
            const alreadyCommented = comments.data.some(comment =>
              comment.body.includes('@codex review') &&
              comment.body.includes(latestCommit.substring(0, 7))
            );

            if (alreadyCommented) {
              console.log('Already requested review for this commit');
              return;
            }

            // Post review request
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@codex review (${latestCommit.substring(0, 7)})`
            });
